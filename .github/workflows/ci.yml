name: CI - Coq + Python + Julia

on:
  push:
  pull_request:
  schedule:
    - cron: "17 2 * * *"  # nightly at 02:17 UTC

env:
  COQ_VERSION: "8.18.0"   # adjust if your code requires a different minor
  PYTHON_VERSION: "3.11"
  JULIA_VERSION: "1.10"

jobs:
  coq-python-julia:
    name: Coq/Python/Julia
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make helper scripts executable
        run: |
          chmod +x .github/scripts/*.sh || true
          chmod +x tools/*.sh || true

      - name: Restore opam cache
        id: cache-opam
        uses: actions/cache@v4
        with:
          path: |
            ~/.opam
            ~/.cache/opam
          key: ${{ runner.os }}-opam-${{ env.COQ_VERSION }}-${{ hashFiles('**/*.opam', '**/_CoqProject') }}
          restore-keys: |
            ${{ runner.os }}-opam-${{ env.COQ_VERSION }}-
            ${{ runner.os }}-opam-

      - name: Setup Coq
        uses: coq-community/setup-coq@v2
        with:
          coq: ${{ env.COQ_VERSION }}

      - name: Install opam dependencies
        run: |
          set -euo pipefail
          opam update
          if ls *.opam >/dev/null 2>&1; then
            opam install --yes . --deps-only
          elif [ -f Coq/_CoqProject ]; then
            opam install --yes coq-platform-minimal
          else
            echo "No .opam files or _CoqProject found; skipping opam dependency install."
          fi
        shell: bash

      - name: Build Coq (run build script)
        run: bash .github/scripts/build_coq.sh
        shell: bash

      - name: Upload coq-build.log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: coq-build-log
          path: .github/logs/coq-build.log
          if-no-files-found: ignore

      - name: Check for Axiom/Admitted
        run: bash .github/scripts/check_coq_no_admitted.sh
        shell: bash

      - name: Upload admitted hits on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: coq-admitted-hits
          path: .github/logs/coq_admitted_hits.txt
          if-no-files-found: ignore

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install Python dev requirements
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          python -m pip install -r requirements-dev.txt

      - name: Run Python tests (with coverage)
        run: |
          python -m pytest

      - name: Upload coverage.xml (Python)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-xml
          path: coverage.xml
          if-no-files-found: ignore

      - name: Set up Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: ${{ env.JULIA_VERSION }}

      - name: Cache Julia deps
        uses: actions/cache@v4
        with:
          path: ~/.julia
          key: julia-${{ runner.os }}-${{ env.JULIA_VERSION }}-${{ hashFiles('Project.toml', 'Manifest.toml') }}
          restore-keys: |
            julia-${{ runner.os }}-${{ env.JULIA_VERSION }}-

      - name: Run Julia tests
        run: |
          julia --project=. -e 'using Pkg; isfile("Project.toml") || Pkg.generate("UELAT"); Pkg.activate("."); Pkg.instantiate(); Pkg.test()'
