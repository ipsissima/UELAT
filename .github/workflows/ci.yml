name: CI - Coq + Python + Julia

on:
  push:
  pull_request:

env:
  COQ_VERSION: '8.17.0'
  PYTHON_VERSION: '3.11'
  JULIA_VERSION: '1.9'

jobs:
  coq-python-julia:
    name: Coq/Python/Julia (${{ matrix.python-version }}, ${{ matrix.julia-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11']
        julia-version: ['1.9', '1.10']
    env:
      COQ_VERSION: ${{ env.COQ_VERSION }}
      PYTHON_VERSION: ${{ matrix.python-version }}
      JULIA_VERSION: ${{ matrix.julia-version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore opam cache
        id: cache-opam
        uses: actions/cache@v4
        with:
          path: |
            ~/.opam
            ~/.cache/opam
          key: ${{ runner.os }}-opam-${{ env.COQ_VERSION }}-${{ hashFiles('**/*.opam', '**/_CoqProject') }}
          restore-keys: |
            ${{ runner.os }}-opam-${{ env.COQ_VERSION }}-
            ${{ runner.os }}-opam-

      - name: Setup Coq
        uses: coq-community/setup-coq@v2
        with:
          coq: ${{ env.COQ_VERSION }}

      - name: Install opam dependencies
        if: ${{ hashFiles('**/*.opam') != '' }}
        run: |
          set -euo pipefail
          opam update
          opam install . --deps-only --yes
        shell: bash

      - name: Build Coq project
        id: build_coq
        run: bash .github/scripts/build_coq.sh
        shell: bash

      - name: Check for Admitted or Axiom
        if: ${{ success() }}
        run: bash .github/scripts/check_coq_no_admitted.sh
        shell: bash

      - name: Setup Python
        if: ${{ success() }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Restore pip cache
        if: ${{ success() }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        if: ${{ success() }}
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pytest
          fi
        shell: bash

      - name: Run pytest
        if: ${{ success() }}
        run: pytest -q
        shell: bash

      - name: Setup Julia
        if: ${{ success() }}
        uses: julia-actions/setup-julia@v1
        with:
          version: ${{ matrix.julia-version }}

      - name: Restore Julia depot cache
        if: ${{ success() }}
        uses: actions/cache@v4
        with:
          path: ~/.julia
          key: ${{ runner.os }}-julia-${{ matrix.julia-version }}-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-${{ matrix.julia-version }}-
            ${{ runner.os }}-julia-

      - name: Run Julia tests
        if: ${{ success() }}
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.test()'
        shell: bash

      - name: Upload Coq build log
        if: ${{ always() && steps.build_coq.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: coq-build-log-${{ matrix.python-version }}-${{ matrix.julia-version }}
          path: coq-build.log
          if-no-files-found: ignore
